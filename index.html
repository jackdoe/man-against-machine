<!DOCTYPE html>
<html>
  <body>
    <a href="javascript: next()">next random</a> current: <b id='current'></b>, age: <span id='ages'><b id='selected_age'></b></span><br>
    <div id="player"></div>
    <script>
var VIDEOS  = undefined;
var CURRENT = undefined;
var PLAYER  = undefined;
var ITER    = 0;

var shuffle = function(array) {
    // http://stackoverflow.com/a/6274398/1075083
    var counter = array.length, temp, index;
    while (counter > 0) {
        index = Math.floor(Math.random() * counter);
        counter--;
        temp = array[counter];
        array[counter] = array[index];
        array[index] = temp;
    }
    return array;
}

var add = function(into, from, to, id, title) {
    for (var age = from; age <= to; age++) {
        if (!into[age])
            into[age] = [];
        into[age].push({id: id, title: title});
    }
}

var populate = function() {
    var v = {};

    add(v, 0, 5, 'L0MK7qz13bU', 'frozen');
    add(v, 0, 5, 'hSQxjB1Jdkw', 'finger song');
    add(v, 0, 5, 'u9zAJz2wyG8', 'peppa');
    add(v, 5, 5, 'XU1y7pX7dNo', 'kids-yoga');

    return v;
}

var pick = function() {
    var obj = CURRENT[ITER++ % CURRENT.length]
    document.getElementById('current').innerHTML = JSON.stringify(obj);
    return obj.id;
}

var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var onYouTubeIframeAPIReady = function() {
    PLAYER = new YT.Player('player', {
        height: window.innerHeight - 40,
        width: window.innerWidth - 20,
        videoId: pick(),
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
        }
    });
}

var onPlayerReady = function(event) {
    event.target.playVideo();
}

var next = function() {
    PLAYER.loadVideoById(pick());
}

var onPlayerStateChange = function(event) {
    if (event.data == YT.PlayerState.ENDED)
        next();
}

var init = function() {
    VIDEOS = populate();
    CURRENT = shuffle(VIDEOS[localStorage.age || 5])

    var s = '';
    for (var k in VIDEOS) {
        var inner = k + '[' + VIDEOS[k].length + ']';
        if (localStorage.age == k)
            s += inner + '&nbsp;';
        else
            s += '<a href="javascript: localStorage.age=' + k + '; init(); next(); ">' + inner  +'</a>&nbsp;';
    }
    document.getElementById('ages').innerHTML = s;
}

init();
    </script>
  </body>
</html>
